<span style="color:red">Forecasting with Times Series Data
========================================================

In Ecology we don't always just want to understand current and past ecological processes, sometimes we want to look into the future. For example, we may want to project how long it will take an endangered species to become extinct if threats continue. We may also want to project how biotic populations or distributions will respond to continuing anthropogenic climate change. Predicting the future, or *forecasting* has the been the focus of a great deal of statistical research in the field of economics and we can apply the same techniques to ecological questions. Here we will focus on *time-series forecasting*, where we will use historical data collected over time to predict conditions in the future. We will use Rob Hyndman's *forecast* R-package.

```{r results='hide', message=FALSE, warning=FALSE}
library(forecast)
```

##Simple exponential smoothing models - Annual rainforest loss in the Brazilian Amazon

Our first example will use annual rainforest loss (ha) (DF) data collected by satellite imagery over 25 years (time) in the Tocantins region of the Brazilian Amazon. We will enter the data manually.

```{r}
DF <- c(1650,730,580,440,409,333,333,797,320,273,576,216,244,189,212,
        156,158,271,124,63,107,61,49,40,52)
time <- c(1988:2012)
```

First, we will set up the data in time series format. 

```{r}
data1 <- ts(c(t(DF)), start = 1988, end = 2012, frequency = 1)
data1
```

We can then split the data into training and test data using the `window()` function. In this example, we will try to forecast rainforest loss for the last three years in the time series (2010-2012), which will be our test data. In this way, we will be able to check our forecasted values against real observations. 

```{r}
data_train <- window(data1, start = 1988, end = 2010-.1, frequency = 1)
data_test <- window(data1, start = 2010, end = 2012, frequency = 1)
```

Now that we have formatted our data appropriately, we will fit a simple exponential smoothing model using the `ets()` function. This model uses a weighted average of past observations, with the weights decreasing exponentially into the past. This means that the most recent observations get the highest weight and therefore influence the predictions the most. In the `ets()` funciton the model type is expressed as a three-character code representing the error type (first character), the trend type (second character) and the season type (third character). We will use the model type *ANN* which is a simple exponential smoothing model with additive errors (A), no assumed trend (N) and no seasonality (N). 

```{r}
fit1 <- ets(data_train, model = "ANN")  
```

Now that we have fit the model using our training data (1988-2009), we can use the model to predict rainforest loss in the most recent 3 years (2010-2012).

```{r}
year_forecast <- 3
fit1_forecast <- forecast(fit1, h = year_forecast) 
fit1_forecast
```

The output of our forecast gives us the forecasted values (Forecast) for each year (Point) and then the 80% and 95% confidence intervals. How did we do? By using the `plot()` function on a *forecast* object, we can see a plot of the historical trend (line), with our forecast observations (blue points) and our confidence intervales (95% - grey shading, 80% - blue shading). In this case we already have historical data for our predicted points, so we will plot them on top using the `points()` function (black squares). 

```{r}
plot(fit1_forecast)  
points(time[23:25], DF[23:25], lty = 1, col = "black", lwd = 3, pch = 0)
legend("topright", legend = c("observed", "forecasted"), lwd = 3, 
       col = c("black","blue"), lty = c(0,0), merge = TRUE, 
       bty = "n", pch = c(0,19), cex = 1.3)
```

The value for alpha (the smoothing parameter) was estimated to be 0.7587, which means a relatively fast decay of observation weights into the past. In other words, the past observations have a relatively small influence on future predictions. 

From our figure we see a strong downward trend, so we could add an additive trend in the model. This is simply done by changing the second character in our model code to "A" (additive) and repeating the process. 

```{r}
fit2 <- ets(data_train, model = "AAN") 
fit2_forecast <- forecast(fit2, h = year_forecast)
```

We can compare the simple exponential model with the model incorporating the additive trend by plotting them side by side.
```{r}
par(mfrow = c(1,2))

plot(fit1_forecast,main="Simple exponential model") 
points(time[23:25], DF[23:25], lty = 1, col = "black", lwd = 4, pch = 0)

plot(fit2_forecast, main="Additive trend model")
points(time[23:25], DF[23:25], lty = 1, col = "black", lwd = 4, pch = 0)

legend("topright", legend = c("observed", "forecasted"), lwd = 4, 
       col = c("black","blue"), lty = c(0,0), merge = TRUE, 
       bty = "n", pch=c(0,19), cex = 1.3)
```

Which model do you think performs better? Another option is to fit all possible models and select the best model using AIC. This is done simply by not specifying any model structure in the `ets()` command. 

```{r}
fit3 <- ets(data_train)
fit3_forecast <- forecast(fit3, h = year_forecast)
fit3$method
```

If you are interested in which model structure was selected you can extract it from the model object `fit3$method`. In this case the model structure was *MNN*: a model with multiplicative errors (M), but no overall trend (N) or seasonality (N) assumed. Now we can plot all three models to see which is giving us the best approximation of our observed measurements of rainforest loss.  

```{r}
par(mfrow = c(1,3))

plot(fit1_forecast, main="Simple exponential model") 
plot(fit2_forecast, main="Additive trend model")   
plot(fit3_forecast, main="Best model (lowest AIC)")  
points(time[23:25], DF[23:25], lty = 1, col = "black", lwd = 4, pch = 0)

legend("topright", legend = c("observed", "forecasted"), lwd = 4, 
       col = c("black","blue"), lty = c(0,0), merge = TRUE, 
       bty = "n", pch = c(0,19), cex = 1.3)
```

We can also predict future rainforest loss (so no test data). Let's keep the prediction at three years but include all of our historical observations in the training data. We will again use the AIC model selection method. 

```{r}
data_train <- window(data1, start = 1988, end = 2012-.1, frequency = 1)

fit4 <- ets(data_train)

fit4_forecast <- forecast(fit4, h = year_forecast)

par(mfrow = c(1,1))

plot(fit4_forecast)
```

The forecast is for decreasing rainforest loss in the Amazon, so good news! 

##Models incorporating seasonal variability - Australian monthly gas production

Let's try another example that incorporates not only long-term trends but seasonal variability as well. We will use an example used in [https://www.otexts.org/fpp](Rob Hyndman and George Athanasopoulos' online textbook) and included in the *forecast* package: Australian monthly gas production. We will start by plotting the historical data from 1956 to 1995. If we plot the data, we can see two patterns: an overall positive trend and a zig-zagging seasonal pattern. 

```{r}
data(gas)

par(mfrow = c(1,1))
plot(gas)
```

If we use our first model, the simple exponential model that doesn't assume a trend or seasonality (*ANN*), we get the following:

```{r}
fit_gas1 <- ets(gas, model = "ANN")
year_forecast <- 3*12   # 3 years times 12 months.
fit_gas1_forecast <- forecast(fit_gas1, h = year_forecast)

plot(fit_gas1_forecast, main="Simple exponential model") 
```

As expected, we can see that the model does a pretty poor job of predicting the overall trend or the seasonal variability. In fact the model predicts constant gas production over the 3 years (or 36 monthly time steps). 

Now let's fit the model assuming additive seasonal varibility (*ANA*). 

```{r}
fit_gas2 <- ets(gas, model = "ANA")
fit_gas2_forecast <- forecast(fit_gas2, h = year_forecast)

par(mfrow = c(1,2))
plot(fit_gas1_forecast, main="Simple exponential model") 
plot(fit_gas2_forecast, main="Seasonal trend model") 
```

This model looks a lot more convincing that the simple exponential fit. Finally, let's let the `ets()` function choose the best model using AIC.

```{r}
fit_gas3 <- ets(gas)
fit_gas3_forecast <- forecast(fit_gas3, h = year_forecast)

par(mfrow = c(1,3))
plot(fit_gas1_forecast, main="Simple exponential model") 
plot(fit_gas2_forecast, main="Seasonal trend model") 
plot(fit_gas3_forecast, main="Best model (lowest AIC)")
```

## Further help

For more details on the package and time-series forecasting in general, 
see [Rob Hyndman and George Athanasopoulos' online textbook](https://www.otexts.org/fpp). This script is based on the [Ecostats Research Blog post](http://eco-stats.blogspot.com.au/2015/07/forecasting-with-time-series-data.html) and BEES R User group meeting workshop by Jakub Stoklosa. It's also worth checking out the scripts and example data from other BEES R User group meetings that cover a range of interesting topics [here](https://github.com/mitchest/BEES-ecocomp).

**Author**: Jakub Stoklosa & Rachel V. Blakey

Last updated:
```{r,echo=F}
date()
```
